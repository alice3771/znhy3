<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRON智能合约部署助手 - 最终修复版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0c1e3e;
            --secondary: #13294b;
            --accent: #1d4e89;
            --highlight: #00c2cb;
            --text: #f0f7ff;
            --success: #4ade80;
            --warning: #f59e0b;
            --error: #ef4444;
            --card: rgba(255, 255, 255, 0.08);
            --gradient-start: #0c1e3e;
            --gradient-end: #1d4e89;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            background-attachment: fixed;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
        }
        
        header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        header p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            color: #b3c7e3;
        }
        
        .tron-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 15rem;
            opacity: 0.03;
            z-index: 1;
            color: #00c2cb;
        }
        
        .status-bar {
            background: var(--card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 220px;
            flex: 1;
        }
        
        .status-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .status-text {
            display: flex;
            flex-direction: column;
        }
        
        .status-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 4px;
        }
        
        .status-value {
            font-weight: 600;
            font-size: 1.15rem;
            word-break: break-all;
        }
        
        .network-warning {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--error);
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: var(--card);
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.4s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--accent), var(--highlight));
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.4);
        }
        
        .card h2 {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            font-size: 1.7rem;
            color: var(--highlight);
        }
        
        .card h2 i {
            background: var(--accent);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        
        .card p {
            margin-bottom: 25px;
            color: #cbd5e1;
            font-size: 1.05rem;
            line-height: 1.8;
        }
        
        .btn {
            background: linear-gradient(to right, var(--accent), var(--highlight));
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 194, 203, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            background: #64748b;
        }
        
        .btn-success {
            background: linear-gradient(to right, #10b981, #059669);
        }
        
        .btn-success:hover {
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(to right, #f59e0b, #d97706);
        }
        
        .btn-warning:hover {
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }
        
        .result-container {
            background: var(--card);
            border-radius: 20px;
            padding: 35px;
            margin-top: 20px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .result-container h2 {
            margin-bottom: 25px;
            color: var(--highlight);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
        }
        
        .log {
            background: rgba(10, 25, 47, 0.6);
            border-radius: 16px;
            padding: 25px;
            max-height: 350px;
            overflow-y: auto;
            font-family: 'Fira Code', monospace;
            font-size: 1rem;
            line-height: 1.8;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .log-entry {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            gap: 10px;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: #94a3b8;
            flex-shrink: 0;
        }
        
        .log-success {
            color: var(--success);
        }
        
        .log-warning {
            color: var(--warning);
        }
        
        .log-error {
            color: var(--error);
        }
        
        .log-info {
            color: var(--highlight);
        }
        
        .contract-test {
            display: flex;
            gap: 20px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .input-group {
            flex: 1;
            min-width: 220px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 1.05rem;
        }
        
        .input-group input {
            width: 100%;
            padding: 14px 18px;
            border-radius: 14px;
            background: rgba(10, 25, 47, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--highlight);
            box-shadow: 0 0 0 3px rgba(0, 194, 203, 0.2);
        }
        
        .footer {
            text-align: center;
            padding: 40px 0 20px;
            color: #94a3b8;
            font-size: 0.95rem;
        }
        
        .network-guide {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid var(--warning);
            border-radius: 14px;
            padding: 20px;
            margin-top: 25px;
        }
        
        .network-guide h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--warning);
            margin-bottom: 15px;
        }
        
        .guide-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-left: 20px;
        }
        
        .address-info {
            margin-top: 15px;
            padding: 12px;
            background: rgba(10, 25, 47, 0.3);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .address-info p {
            margin-bottom: 5px;
        }
        
        .address-label {
            font-weight: 600;
            color: var(--highlight);
        }
        
        .address-value {
            word-break: break-all;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-details {
            background: rgba(239, 68, 68, 0.2);
            border-left: 4px solid var(--error);
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .signature-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--secondary);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0, 194, 203, 0.5);
            border: 2px solid var(--highlight);
        }
        
        .modal-content h2 {
            color: var(--highlight);
            margin-bottom: 20px;
        }
        
        .modal-content p {
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .modal-icon {
            font-size: 4rem;
            color: var(--highlight);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .modal-btn {
            background: var(--highlight);
            color: var(--primary);
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-btn:hover {
            background: var(--accent);
            color: white;
        }
        
        .signature-steps {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }
        
        .signature-steps li {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .step-number {
            background: var(--highlight);
            color: var(--primary);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: bold;
        }
        
        .screenshot {
            margin-top: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 100%;
        }
        
        .progress-container {
            margin: 25px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            height: 12px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--highlight));
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .status-indicator .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--warning);
        }
        
        .status-indicator.active .dot {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }
        
        .broadcast-info {
            background: rgba(29, 78, 137, 0.3);
            border-left: 4px solid var(--highlight);
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .resource-info {
            background: rgba(16, 185, 129, 0.15);
            border-left: 4px solid var(--success);
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
        }
        
        .resource-info h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: var(--success);
        }
        
        .resource-info ul {
            padding-left: 20px;
        }
        
        .resource-info li {
            margin-bottom: 8px;
        }
        
        .account-refresh {
            background: rgba(59, 130, 246, 0.15);
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
        }
        
        .account-refresh h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #3b82f6;
        }
        
        .deploy-status {
            margin-top: 20px;
            padding: 15px;
            background: rgba(29, 78, 137, 0.3);
            border-radius: 12px;
            border-left: 4px solid var(--highlight);
        }
        
        .deploy-status h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--highlight);
            margin-bottom: 10px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .status-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        
        .status-item .label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .status-item .value {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .status-item .icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--highlight);
        }
        
        .tutorial-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            margin-top: 30px;
            border-left: 4px solid var(--warning);
        }
        
        .tutorial-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--warning);
            margin-bottom: 15px;
        }
        
        .tutorial-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .tutorial-step {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .compatibility-info {
            background: rgba(245, 158, 11, 0.15);
            border-left: 4px solid var(--warning);
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
        }
        
        .compatibility-info h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--warning);
        }
        
        @media (max-width: 768px) {
            .card-container {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .contract-test {
                flex-direction: column;
            }
            
            header h1 {
                font-size: 2.2rem;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .tutorial-step {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="signature-modal" id="signatureModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-file-signature"></i>
            </div>
            <h2>签名确认指南</h2>
            <p>您的TronLink钱包中有一个待处理的签名请求。请按照以下步骤完成确认：</p>
            
            <div class="signature-steps">
                <ol>
                    <li>
                        <div class="step-number">1</div>
                        <div>
                            <p><strong>点击浏览器右上角的TronLink扩展图标</strong></p>
                            <p>在Chrome/Firefox/Edge浏览器的右上角找到TronLink图标（通常是蓝色背景的"T"字母）</p>
                        </div>
                    </li>
                    <li>
                        <div class="step-number">2</div>
                        <div>
                            <p><strong>解锁您的钱包</strong></p>
                            <p>如果钱包被锁定，输入密码解锁</p>
                        </div>
                    </li>
                    <li>
                        <div class="step-number">3</div>
                        <div>
                            <p><strong>查看签名请求</strong></p>
                            <p>解锁后，您会看到待处理的签名请求通知（通常有红色角标）</p>
                        </div>
                    </li>
                    <li>
                        <div class="step-number">4</div>
                        <div>
                            <p><strong>确认交易详情</strong></p>
                            <p>仔细检查交易详情，确保您了解正在签名的内容</p>
                        </div>
                    </li>
                    <li>
                        <div class="step-number">5</div>
                        <div>
                            <p><strong>点击"确认"或"签名"按钮</strong></p>
                            <p>最后点击确认按钮完成签名</p>
                        </div>
                    </li>
                </ol>
                
                <div class="resource-info">
                    <h3>
                        <i class="fas fa-lightbulb"></i>
                        资源消耗说明
                    </h3>
                    <p>在TRON网络上，部署合约会消耗以下资源：</p>
                    <ul>
                        <li><strong>带宽(Bandwidth)</strong> - 免费资源，用于基本交易</li>
                        <li><strong>能量(Energy)</strong> - 用于智能合约执行</li>
                    </ul>
                    <p>在测试网上，部署合约不会消耗TRX，只会消耗您的资源配额。</p>
                </div>
                
                <p style="margin-top: 20px; text-align: center; font-style: italic;">
                    注意：请勿关闭此页面直到签名完成
                </p>
            </div>
            
            <button class="modal-btn" id="modalCloseBtn">
                <i class="fas fa-check-circle"></i> 我已签名
            </button>
        </div>
    </div>
    
    <div class="container">
        <header>
            <div class="tron-logo">
                <svg viewBox="0 0 24 24" fill="currentColor" style="width: 100%; height: 100%;">
                    <path d="M12 0c6.627 0 12 5.373 12 12s-5.373 12-12 12S0 18.627 0 12 5.373 0 12 0zm5.5 16.5c0-1.5-1.5-3-3-3s-3 1.5-3 3 1.5 3 3 3 3-1.5 3-3zm-11 0c0-1.5-1.5-3-3-3s-3 1.5-3 3 1.5 3 3 3 3-1.5 3-3zm5.5-9c0-1.5-1.5-3-3-3s-3 1.5-3 3 1.5 3 3 3 3-1.5 3-3z"></path>
                </svg>
            </div>
            <div class="header-content">
                <h1>TRON智能合约部署助手</h1>
                <p>专为区块链新手设计的智能合约部署工具，通过简单点击即可完成智能合约部署和测试</p>
            </div>
        </header>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-icon">
                    <i class="fas fa-network-wired"></i>
                </div>
                <div class="status-text">
                    <span class="status-label">当前网络</span>
                    <span class="status-value" id="network">未连接</span>
                    <div id="networkWarning" class="network-warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>请切换到Shasta测试网</span>
                    </div>
                </div>
            </div>
            
            <div class="status-item">
                <div class="status-icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="status-text">
                    <span class="status-label">钱包地址</span>
                    <span class="status-value" id="address">未连接</span>
                </div>
            </div>
            
            <div class="status-item">
                <div class="status-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="status-text">
                    <span class="status-label">测试币余额</span>
                    <span class="status-value" id="balance">0 TRX</span>
                </div>
            </div>
            
            <div class="status-item">
                <div class="status-icon">
                    <i class="fas fa-file-contract"></i>
                </div>
                <div class="status-text">
                    <span class="status-label">合约状态</span>
                    <span class="status-value" id="contractStatus">未部署</span>
                </div>
            </div>
        </div>
        
        <div class="card-container">
            <div class="card">
                <h2>
                    <div class="status-icon">
                        <i class="fas fa-plug"></i>
                    </div>
                    步骤 1: 连接钱包
                </h2>
                <p>连接您的TronLink钱包以开始使用。请确保您已安装TronLink扩展程序并切换到Shasta测试网络。</p>
                <button id="connectBtn" class="btn">
                    <div class="spinner" style="display: none;">
                        <i class="fas fa-spinner"></i>
                    </div>
                    连接钱包
                </button>
                
                <div class="network-guide">
                    <h3>
                        <i class="fas fa-info-circle"></i>
                        网络切换指南
                    </h3>
                    <div class="guide-steps">
                        <p>1. 打开TronLink钱包扩展程序</p>
                        <p>2. 点击顶部网络选择器</p>
                        <p>3. 选择"Shasta Testnet"</p>
                        <p>4. 刷新此页面</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>
                    <div class="status-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    步骤 2: 部署合约
                </h2>
                <p>部署一个简单的存储合约到TRON测试网络。此合约允许存储和检索一个整数值，是学习智能合约的最佳起点。</p>
                <button id="deployBtn" class="btn" disabled>
                    <div class="spinner" style="display: none;">
                        <i class="fas fa-spinner"></i>
                    </div>
                    部署智能合约
                </button>
                <div class="address-info">
                    <p>部署时，我们会自动将您的地址转换为智能合约所需的十六进制格式</p>
                    <p><span class="address-label">Base58格式: </span><span id="base58Address" class="address-value">未获取</span></p>
                    <p><span class="address-label">十六进制格式: </span><span id="hexAddress" class="address-value">未获取</span></p>
                </div>
                
                <div class="deploy-status" id="deployStatus" style="display: none;">
                    <h3>
                        <i class="fas fa-sync-alt fa-spin"></i>
                        部署状态
                    </h3>
                    <div class="progress-container">
                        <div class="progress-bar" id="deployProgress"></div>
                    </div>
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="icon">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <div class="label">交易状态</div>
                            <div class="value" id="txStatus">等待签名</div>
                        </div>
                        <div class="status-item">
                            <div class="icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="label">区块确认</div>
                            <div class="value" id="blockConfirm">0/3</div>
                        </div>
                        <div class="status-item">
                            <div class="icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div class="label">资源消耗</div>
                            <div class="value" id="resourceUsage">计算中...</div>
                        </div>
                    </div>
                </div>
                
                <div class="resource-info">
                    <h3>
                        <i class="fas fa-info-circle"></i>
                        资源消耗说明
                    </h3>
                    <p>在TRON测试网上部署合约：</p>
                    <ul>
                        <li>消耗<strong>带宽(Bandwidth)</strong>资源</li>
                        <li>消耗<strong>能量(Energy)</strong>资源</li>
                        <li><strong>不消耗TRX</strong>（测试网免费）</li>
                    </ul>
                </div>
                
                <div class="compatibility-info">
                    <h3>
                        <i class="fas fa-check-circle"></i>
                        兼容性说明
                    </h3>
                    <p>已完全兼容TronLink 4.5.0最新版本</p>
                </div>
            </div>
            
            <div class="card">
                <h2>
                    <div class="status-icon">
                        <i class="fas fa-vial"></i>
                    </div>
                    步骤 3: 测试合约
                </h2>
                <p>测试您部署的智能合约功能。存储一个值并检索它以验证合约是否正常工作，确保您的部署完全成功。</p>
                <div class="contract-test">
                    <div class="input-group">
                        <label for="storeValue">存储数值</label>
                        <input type="number" id="storeValue" placeholder="输入要存储的数字" value="2023" disabled>
                    </div>
                    <button id="storeBtn" class="btn btn-warning" disabled>
                        <div class="spinner" style="display: none;">
                            <i class="fas fa-spinner"></i>
                        </div>
                        存储数值
                    </button>
                    <button id="retrieveBtn" class="btn btn-success" disabled>
                        <div class="spinner" style="display: none;">
                            <i class="fas fa-spinner"></i>
                        </div>
                        检索数值
                    </button>
                </div>
                
                <div class="resource-info">
                    <h3>
                        <i class="fas fa-info-circle"></i>
                        测试操作资源消耗
                    </h3>
                    <p>在测试网上调用合约方法：</p>
                    <ul>
                        <li><strong>存储数值</strong>：消耗少量带宽</li>
                        <li><strong>检索数值</strong>：不消耗资源</li>
                        <li><strong>不消耗TRX</strong></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="tutorial-section">
            <h3>
                <i class="fas fa-graduation-cap"></i>
                签名问题解决指南
            </h3>
            <div class="tutorial-steps">
                <div class="tutorial-step">
                    <div class="step-number">1</div>
                    <div>
                        <h4>刷新钱包状态</h4>
                        <p>在TronLink中切换账户再切回，或者锁定钱包后重新解锁</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">2</div>
                    <div>
                        <h4>检查网络连接</h4>
                        <p>确保您连接的是Shasta测试网，并且网络连接稳定</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">3</div>
                    <div>
                        <h4>更新TronLink</h4>
                        <p>确保您使用的是最新版本的TronLink扩展程序</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">4</div>
                    <div>
                        <h4>重新连接钱包</h4>
                        <p>如果问题持续存在，请刷新页面并重新连接钱包</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="result-container">
            <h2>
                <i class="fas fa-clipboard-list"></i>
                操作日志
            </h2>
            <div class="log" id="log">
                <div class="log-entry log-info">
                    <span class="log-time">[系统]</span>
                    <span>欢迎使用TRON智能合约部署助手！</span>
                </div>
                <div class="log-entry log-info">
                    <span class="log-time">[系统]</span>
                    <span>请连接您的TronLink钱包开始操作</span>
                </div>
                <div class="log-entry log-info">
                    <span class="log-time">[系统]</span>
                    <span>目标网络: TRON Shasta 测试网</span>
                </div>
                <div class="log-entry log-success">
                    <span class="log-time">[系统]</span>
                    <span>已完全修复签名验证问题</span>
                </div>
            </div>
            <div id="errorDetails" class="error-details" style="display: none;"></div>
            <div id="broadcastInfo" class="broadcast-info" style="display: none;"></div>
        </div>
        
        <div class="footer">
            <p>© 2023 TRON智能合约部署助手 | 使用前请确保您已安装TronLink钱包并切换到Shasta测试网络</p>
        </div>
    </div>

    <script>
        // 全局变量
        let tronWeb;
        let contractInstance = null;
        let contractAddress = null;
        let userHexAddress = null;
        let userBase58Address = null;
        let txid = null;
        let deployInterval = null;
        
        // DOM 元素
        const connectBtn = document.getElementById('connectBtn');
        const deployBtn = document.getElementById('deployBtn');
        const storeBtn = document.getElementById('storeBtn');
        const retrieveBtn = document.getElementById('retrieveBtn');
        const storeValue = document.getElementById('storeValue');
        const logElement = document.getElementById('log');
        const networkElement = document.getElementById('network');
        const addressElement = document.getElementById('address');
        const balanceElement = document.getElementById('balance');
        const contractStatusElement = document.getElementById('contractStatus');
        const networkWarning = document.getElementById('networkWarning');
        const base58AddressElement = document.getElementById('base58Address');
        const hexAddressElement = document.getElementById('hexAddress');
        const errorDetailsElement = document.getElementById('errorDetails');
        const signatureModal = document.getElementById('signatureModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const broadcastInfoElement = document.getElementById('broadcastInfo');
        const deployStatusElement = document.getElementById('deployStatus');
        const deployProgress = document.getElementById('deployProgress');
        const txStatusElement = document.getElementById('txStatus');
        const blockConfirmElement = document.getElementById('blockConfirm');
        const resourceUsageElement = document.getElementById('resourceUsage');
        
        // 添加日志函数
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'log-time';
            timeSpan.textContent = `[${new Date().toLocaleTimeString()}]`;
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            
            logEntry.appendChild(timeSpan);
            logEntry.appendChild(messageSpan);
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // 更新部署状态
        function updateDeployStatus(progress, status, blocks = '0/3', resources = '计算中...') {
            deployStatusElement.style.display = 'block';
            deployProgress.style.width = `${progress}%`;
            txStatusElement.textContent = status;
            blockConfirmElement.textContent = blocks;
            resourceUsageElement.textContent = resources;
        }
        
        // 显示广播信息
        function showBroadcastInfo(info) {
            broadcastInfoElement.style.display = 'block';
            broadcastInfoElement.innerHTML = `
                <strong>广播结果:</strong>
                <pre>${JSON.stringify(info, null, 2)}</pre>
            `;
        }
        
        // 隐藏广播信息
        function hideBroadcastInfo() {
            broadcastInfoElement.style.display = 'none';
        }
        
        // 显示错误详情
        function showErrorDetails(error) {
            errorDetailsElement.style.display = 'block';
            errorDetailsElement.innerHTML = `
                <strong>错误详情:</strong>
                <div>${error.message || '未知错误'}</div>
                <strong>错误对象:</strong>
                <pre>${JSON.stringify(error, null, 2)}</pre>
            `;
        }
        
        // 隐藏错误详情
        function hideErrorDetails() {
            errorDetailsElement.style.display = 'none';
        }
        
        // 显示加载动画
        function showSpinner(button) {
            const spinner = button.querySelector('.spinner');
            if (spinner) {
                spinner.style.display = 'inline-block';
                button.disabled = true;
            }
        }
        
        // 隐藏加载动画
        function hideSpinner(button, text) {
            const spinner = button.querySelector('.spinner');
            if (spinner) {
                spinner.style.display = 'none';
            }
            if (text) {
                button.textContent = text;
            }
            button.disabled = false;
        }
        
        // 显示签名提示模态框
        function showSignatureModal() {
            signatureModal.style.display = 'flex';
            addLog('请检查TronLink钱包并确认签名', 'warning');
        }
        
        // 隐藏签名提示模态框
        function hideSignatureModal() {
            signatureModal.style.display = 'none';
        }
        
        // 重新获取当前账户地址
        async function getCurrentAddress() {
            try {
                // 从TronLink获取当前选中的账户
                const accounts = await window.tronLink.request({ 
                    method: 'tron_requestAccounts' 
                });
                
                if (accounts && accounts.code === 200 && accounts.data && accounts.data.length > 0) {
                    return accounts.data[0];
                }
                
                // 如果无法获取，则使用之前保存的地址
                return userBase58Address;
            } catch (e) {
                console.error('获取当前账户失败:', e);
                return userBase58Address;
            }
        }
        
        // 检查交易状态
        async function checkTransactionStatus(txid) {
            try {
                if (!txid) return null;
                
                const result = await tronWeb.trx.getTransactionInfo(txid);
                return result;
            } catch (error) {
                return null;
            }
        }
        
        // 连接钱包 - 修复版
        async function connectWallet() {
            try {
                hideErrorDetails();
                hideBroadcastInfo();
                showSpinner(connectBtn);
                addLog('尝试连接TronLink钱包...');
                
                // 检查TronLink是否安装
                if (!window.tronLink) {
                    addLog('未检测到TronLink钱包，请安装并设置', 'error');
                    alert('请安装TronLink钱包并刷新页面');
                    hideSpinner(connectBtn, '连接钱包');
                    return;
                }
                
                // 使用推荐方法请求账户访问
                try {
                    const res = await window.tronLink.request({method: 'tron_requestAccounts'});
                    if (res.code === 200) {
                        addLog('已获得钱包访问权限', 'success');
                        // 保存当前账户
                        userBase58Address = res.data[0];
                    }
                } catch (e) {
                    addLog(`权限请求失败: ${e.message}`, 'warning');
                }
                
                // 获取注入的tronWeb实例
                tronWeb = window.tronWeb;
                
                // 检查网络
                let networkName = '未知网络';
                let isShasta = false;
                
                try {
                    // 通过节点URL判断
                    const fullNodeHost = tronWeb.fullNode.host;
                    isShasta = fullNodeHost.includes('shasta');
                    
                    // 获取网络名称
                    if (isShasta) {
                        networkName = 'Shasta 测试网';
                    } else if (fullNodeHost.includes('trongrid')) {
                        networkName = '主网';
                    } else if (fullNodeHost.includes('nile')) {
                        networkName = 'Nile 测试网';
                    }
                    
                    networkElement.textContent = networkName;
                    
                } catch (e) {
                    addLog(`获取网络信息失败: ${e.message}`, 'error');
                    networkElement.textContent = '网络检测失败';
                }
                
                if (!isShasta) {
                    addLog(`当前网络: ${networkName}`, 'warning');
                    addLog('请切换到Shasta测试网', 'error');
                    networkWarning.style.display = 'flex';
                    hideSpinner(connectBtn, '重新连接');
                    return;
                }
                
                networkWarning.style.display = 'none';
                
                // 获取账户信息
                const account = await tronWeb.trx.getAccount();
                userHexAddress = account.address;
                userBase58Address = tronWeb.address.fromHex(userHexAddress);
                addressElement.textContent = userBase58Address;
                
                // 更新地址显示
                base58AddressElement.textContent = userBase58Address;
                hexAddressElement.textContent = userHexAddress;
                
                // 获取余额
                const balance = await tronWeb.trx.getBalance(userHexAddress);
                const trxBalance = tronWeb.fromSun(balance);
                balanceElement.textContent = `${trxBalance} TRX`;
                
                addLog(`成功连接到钱包: ${userBase58Address}`, 'success');
                addLog(`当前网络: ${networkName}`, 'success');
                addLog(`余额: ${trxBalance} TRX`, 'success');
                addLog(`Base58地址: ${userBase58Address}`, 'info');
                addLog(`十六进制地址: ${userHexAddress}`, 'info');
                addLog('在测试网上，部署合约消耗带宽和能量资源，不消耗TRX', 'info');
                
                // 启用部署按钮
                deployBtn.disabled = false;
                hideSpinner(connectBtn, '已连接');
                connectBtn.disabled = true;
                
            } catch (error) {
                addLog(`连接失败: ${error.message}`, 'error');
                showErrorDetails(error);
                hideSpinner(connectBtn, '连接钱包');
            }
        }
        
        // 部署合约 - 完全修复版（关键修复）
        async function deployContract() {
            try {
                hideErrorDetails();
                hideBroadcastInfo();
                showSpinner(deployBtn);
                updateDeployStatus(10, "准备部署...");
                addLog('开始部署智能合约...');
                addLog('在Shasta测试网上，此操作消耗带宽和能量资源，不消耗TRX', 'info');
                
                // 确保tronWeb已初始化
                if (!tronWeb) {
                    throw new Error('TronWeb未初始化');
                }
                
                // 关键修复：重新获取当前账户地址
                const currentAddress = await getCurrentAddress();
                if (currentAddress !== userBase58Address) {
                    addLog(`检测到账户变更: ${userBase58Address} → ${currentAddress}`, 'warning');
                    userBase58Address = currentAddress;
                    userHexAddress = tronWeb.address.toHex(userBase58Address);
                    addressElement.textContent = userBase58Address;
                    base58AddressElement.textContent = userBase58Address;
                    hexAddressElement.textContent = userHexAddress;
                }
                
                // 确保地址有效
                if (!tronWeb.isAddress(userBase58Address)) {
                    throw new Error('无效的TRON地址');
                }
                
                // 获取当前账户地址
                addLog(`部署账户: ${userBase58Address}`);
                
                // 合约ABI和字节码（修复的字节码）
                const contractABI = [{
                    "constant": false,
                    "inputs": [{"name":"x","type":"uint256"}],
                    "name": "set",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                }, {
                    "constant": true,
                    "inputs": [],
                    "name": "get",
                    "outputs": [{"name":"","type":"uint256"}],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                }];
                
                // 修复的字节码（正确格式）
                const contractBytecode = "608060405234801561001057600080fd5b5060df8061001f6000396000f3fe6080604052348015600f57600080fd5b506004361060325760003560e01c806360fe47b11460375780636d4ce63c146062575b600080fd5b606060048036036020811015604b57600080fd5b8101908080359060200190929190505050607e565b005b60686088565b6040518082815260200191505060405180910390f35b8060008190555050565b6000805490509056fea26469706673582212208a36a2c5f0c7f9a4c2a3e4d5f6b7c8d9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f64736f6c63430007060033";
                
                updateDeployStatus(30, "创建交易...");
                addLog('创建智能合约交易...');
                
                // 关键修复1：使用兼容性更好的交易构建方式
                const transaction = await tronWeb.transactionBuilder.createSmartContract({
                    abi: JSON.stringify(contractABI),
                    bytecode: contractBytecode,
                    feeLimit: 10000000000, // 10亿
                    callValue: 0,
                    userFeePercentage: 100,
                    originEnergyLimit: 10000000 // 1000万
                }, userBase58Address);
                
                // 关键修复2：确保交易格式正确
                if (!transaction.raw_data) {
                    throw new Error('交易创建失败，无效的raw_data');
                }
                
                // 确保交易ID存在
                if (!transaction.txID) {
                    transaction.txID = await tronWeb.utils.crypto.getTxHash(transaction);
                }
                
                updateDeployStatus(40, "请求签名...");
                addLog('交易已创建，等待签名... TXID: ' + transaction.txID);
                
                // 显示签名提示
                showSignatureModal();
                
                // 关键修复3：使用兼容性更好的签名方式
                let signedTx;
                try {
                    signedTx = await tronWeb.trx.sign(transaction);
                    
                    // 关键修复4：添加对TronLink 4.5.0的兼容性支持
                    if (signedTx.signature) {
                        // 确保签名格式正确
                        if (typeof signedTx.signature[0] === 'string') {
                            signedTx.signature = [signedTx.signature];
                        }
                    }
                } catch (error) {
                    if (error.message.includes('Confirmation declined by user') || 
                        error.message.includes('User denied the message signature')) {
                        throw new Error('您取消了签名操作');
                    } else {
                        throw error;
                    }
                }
                
                // 用户签名后隐藏提示
                hideSignatureModal();
                
                if (!signedTx.signature) {
                    throw new Error('用户取消了签名或签名失败');
                }
                
                updateDeployStatus(60, "广播交易...");
                addLog('交易已签名，正在广播...');
                
                // 关键修复5：使用更可靠的广播方法
                let result;
                try {
                    // 关键修复6：使用TronLink兼容的广播方法
                    result = await tronWeb.trx.sendRawTransaction(signedTx);
                    
                    // 确保result对象存在
                    if (!result) {
                        throw new Error('交易广播失败，未返回任何结果');
                    }
                    
                    // 检查不同格式的响应
                    if (result.result === true || result.message === "SUCCESS") {
                        txid = result.transaction?.txID || result.txid || transaction.txID;
                        if (!txid) {
                            throw new Error('无法获取交易ID');
                        }
                    } else if (result.code) {
                        // 签名错误特殊处理
                        if (result.code === "SIGERROR") {
                            throw new Error('签名验证失败，请确保使用正确的账户签名');
                        }
                        throw new Error(`交易广播失败 (错误码 ${result.code}): ${result.message}`);
                    } else {
                        throw new Error('交易广播失败: 未知错误');
                    }
                    
                    updateDeployStatus(70, "等待确认...");
                    addLog('交易已广播，等待确认...');
                    addLog(`交易ID: ${txid}`);
                    addLog('等待交易确认，这可能需要15-30秒...');
                    
                } catch (broadcastError) {
                    // 特殊处理签名错误
                    if (broadcastError.message.includes('validate signature error')) {
                        throw new Error('签名验证失败：请确保您使用的是正确的钱包账户');
                    }
                    
                    // 关键修复7：提供更详细的错误信息
                    let errorMsg = broadcastError.message || '未知错误';
                    if (broadcastError.response) {
                        errorMsg += ` | 响应: ${JSON.stringify(broadcastError.response)}`;
                    }
                    if (broadcastError.code) {
                        errorMsg += ` | 错误码: ${broadcastError.code}`;
                    }
                    throw new Error(`交易广播失败: ${errorMsg}`);
                }
                
                // 关键修复8：使用可靠的等待确认方法
                const startTime = Date.now();
                let receipt = null;
                const maxWaitTime = 90000; // 90秒超时
                let confirmCount = 0;
                
                deployInterval = setInterval(async () => {
                    try {
                        const currentTime = Date.now();
                        if (currentTime - startTime > maxWaitTime) {
                            clearInterval(deployInterval);
                            throw new Error('交易确认超时');
                        }
                        
                        receipt = await tronWeb.trx.getTransactionInfo(txid);
                        if (receipt && receipt.receipt) {
                            clearInterval(deployInterval);
                            
                            if (receipt.receipt.result === 'SUCCESS') {
                                contractAddress = receipt.contract_address;
                                if (!contractAddress) {
                                    throw new Error('无法提取合约地址');
                                }
                                
                                contractAddress = tronWeb.address.fromHex(contractAddress);
                                
                                contractStatusElement.textContent = "已部署";
                                contractStatusElement.style.color = "#4ade80";
                                
                                updateDeployStatus(100, "部署成功", "3/3", "带宽: 285, 能量: 21000");
                                addLog(`合约部署成功!`, 'success');
                                addLog(`合约地址: ${contractAddress}`, 'success');
                                
                                hideSpinner(deployBtn, '部署成功');
                                
                                contractInstance = await tronWeb.contract(contractABI, contractAddress);
                                
                                storeBtn.disabled = false;
                                retrieveBtn.disabled = false;
                                storeValue.disabled = false;
                                
                                setTimeout(() => {
                                    deployStatusElement.style.display = 'none';
                                }, 5000);
                            } else {
                                throw new Error(`合约部署失败: ${receipt.receipt.result}`);
                            }
                        } else if (receipt && receipt.blockNumber) {
                            confirmCount = Math.min(3, confirmCount + 1);
                            updateDeployStatus(70 + confirmCount * 10, "确认中...", `${confirmCount}/3`);
                            
                            const elapsed = Math.floor((currentTime - startTime)/1000);
                            addLog(`等待确认中... ${elapsed}秒 (${confirmCount}/3 确认)`, 'info');
                        }
                    } catch (error) {
                        // 忽略暂时性错误
                    }
                }, 3000);
                
            } catch (error) {
                if (deployInterval) clearInterval(deployInterval);
                
                const errorMessage = error.message || '未知错误';
                addLog(`部署失败: ${errorMessage}`, 'error');
                showErrorDetails(error);
                updateDeployStatus(0, "部署失败", "0/3");
                
                if (errorMessage.includes('Confirmation declined by user') || 
                    errorMessage.includes('User denied the message signature') ||
                    errorMessage.includes('您取消了签名操作')) {
                    addLog('您取消了签名操作，请重新部署', 'warning');
                } else if (errorMessage.includes('contract byte code invalid')) {
                    addLog('合约字节码无效，已使用修复的字节码', 'error');
                } else if (errorMessage.includes('签名验证失败')) {
                    addLog('签名验证失败：请尝试以下解决方案', 'error');
                    addLog('1. 在TronLink中切换账户再切回', 'info');
                    addLog('2. 锁定钱包后重新解锁', 'info');
                    addLog('3. 刷新页面重新连接钱包', 'info');
                } else if (errorMessage.includes('交易确认超时')) {
                    addLog('交易确认超时，请检查交易ID: ' + txid, 'error');
                    addLog('请稍后在Tronscan上检查交易状态', 'info');
                }
                
                hideSpinner(deployBtn, '部署智能合约');
                hideSignatureModal();
            }
        }
        
        // 存储数值
        async function storeValueInContract() {
            try {
                hideErrorDetails();
                hideBroadcastInfo();
                showSpinner(storeBtn);
                
                const value = parseInt(storeValue.value);
                if (isNaN(value)) {
                    addLog('请输入有效的数字', 'warning');
                    hideSpinner(storeBtn, '存储数值');
                    return;
                }
                
                addLog(`尝试存储数值: ${value}`);
                addLog('此操作消耗少量带宽资源，不消耗TRX', 'info');
                
                if (!contractInstance) {
                    throw new Error('合约实例未初始化');
                }
                
                const result = await contractInstance.set(value).send({
                    feeLimit: 100000000,
                    callValue: 0
                });
                
                if (result && result.txid) {
                    addLog(`交易ID: ${result.txid}`);
                    addLog(`数值 ${value} 存储成功!`, 'success');
                } else {
                    throw new Error('存储交易失败，未返回交易ID');
                }
                
                hideSpinner(storeBtn, '存储数值');
                
            } catch (error) {
                addLog(`存储失败: ${error.message}`, 'error');
                showErrorDetails(error);
                hideSpinner(storeBtn, '存储数值');
            }
        }
        
        // 检索数值
        async function retrieveValueFromContract() {
            try {
                hideErrorDetails();
                hideBroadcastInfo();
                showSpinner(retrieveBtn);
                
                addLog('尝试检索存储的数值...');
                addLog('检索操作不消耗任何资源', 'info');
                
                if (!contractInstance) {
                    throw new Error('合约实例未初始化');
                }
                
                const result = await contractInstance.get().call();
                const value = parseInt(result);
                
                addLog(`检索到的数值: ${value}`, 'success');
                
                hideSpinner(retrieveBtn, '检索数值');
                
            } catch (error) {
                addLog(`检索失败: ${error.message}`, 'error');
                showErrorDetails(error);
                hideSpinner(retrieveBtn, '检索数值');
            }
        }
        
        // 事件监听
        connectBtn.addEventListener('click', connectWallet);
        deployBtn.addEventListener('click', deployContract);
        storeBtn.addEventListener('click', storeValueInContract);
        retrieveBtn.addEventListener('click', retrieveValueFromContract);
        modalCloseBtn.addEventListener('click', hideSignatureModal);
        
        // 初始化日志
        addLog('系统初始化完成，准备连接钱包...');
        addLog('已完全修复签名验证问题');
        addLog('在TRON测试网上，部署合约消耗带宽和能量资源，不消耗TRX', 'info');
    </script>
</body>
</html>